
function toggle2(obj) {
	var el = document.getElementById(obj);
	if ( el.style.display != 'none' ) {
		el.style.display = 'none';
		setCookie(obj, 'none', 1000, '/');
	}
	else {
		el.style.display = '';
		setCookie(obj, '', 1000, '/');
	}
}

function getPosition(element, attribute) {
	// exemple : offsetLeft et offsetTop
	var p = 0;
	while (element) {
		p += element[attribute];
		element = element.offsetParent;
	}
	return p;
}

//au format dd/mm/yyyy
function getDate(strDate){
	var day = strDate.substring(0,2);
	var month = strDate.substring(3,5) - 1;
	var year = strDate.substring(6,10);
	var d = new Date(year, month, day);
	return d;
}
//   0 si date_1=date_2
//   1 si date_1>date_2
//  -1 si date_1<date_2
function dateCompare(date_1, date_2){
	var diff = date_1.getTime()-date_2.getTime();
	return (diff==0?diff:diff/Math.abs(diff));
}

function remplirDateFinPeriode() {
	if (document.getElementById('date_fin').value == '') {
		var dateDebut = document.getElementById('date_debut').value;
		if (dateDebut != '') {
			document.getElementById('date_fin').value = dateDebut;
		}
	}
}

function remplirDateRepetition(cible) {
	if (document.getElementById(cible).value == '') {
		var dateDebut = document.getElementById('date_debut').value;
		if (dateDebut != '') {
			document.getElementById(cible).value = dateDebut;
		}
	}
}

function controlDate(date) {
	if (date != '' && !date.match(/^\d\d\/\d\d\/\d\d\d\d$/)) {
		return false;
	}
	return true;
}

var timerMasquerSousMenu = null;
var SousMenuOpened = false;

function masquerSousMenu(obj) {
	// si on est sur un menu dÃ©roulant, ne pas perdre le focus
	if (document.activeElement.type == 'select-one') {
		return;
	}
	var o = document.getElementById(obj);
	o.style.display = 'none';
	SousMenuOpened = false;
	revertCellule();
}

function masquerSousMenuDelai(obj) {
	timerMasquerSousMenu = setTimeout("masquerSousMenu('" + obj + "')",500);
}

function AnnuleMasquerSousMenu(obj) {
	if (timerMasquerSousMenu){
		clearTimeout(timerMasquerSousMenu);
	}
}

function revertCellule()
{
	document.getElementById(dragElementParent).appendChild(document.getElementById(idDrag));
	document.getElementById(idDrag).style.border = oldDragBorder;
	$('#'+idDrag).tooltip('enable');
}

function windowErreurDeplacement() {
	jQuery("#alertModal .modal-body").html(js_deposerCaseSurDate);
	jQuery("#alertModal").addClass('alert alert-error');
	jQuery("#alertModal").modal();
	setTimeout("jQuery('#alertModal').modal('hide');", 1000);
}

function windowDeplacementOK() {
	jQuery("#alertModal .modal-body").html(js_deplacementOk);
	jQuery("#alertModal").modal();
	setTimeout("jQuery('#alertModal').modal('hide');", 1000);
}

function windowPatienter() {
	jQuery("#alertModal .modal-body").html(js_patienter);
	jQuery("#alertModal").modal();
}

function assombrirPage () {
	var page_screen;
	if ( ! document.getElementById ('page_screen')) {
		page_screen = document.createElement ('DIV');
		page_screen.id = "page_screen";
		var body = document.getElementsByTagName ('BODY')[0];
		body.insertBefore (page_screen, body.firstChild);
	} else {
		page_screen = document.getElementById ('page_screen');
	}
	page_screen.style.height = Math.max (document.body.scrollHeight, document.body.clientHeight) + 'px';
	page_screen.style.width = Math.max (document.body.scrollWidth, document.body.clientWidth) + 'px';
	page_screen.style.display = 'block';
}


function retablirPage () {
	var page_screen = document.getElementById ('page_screen');
	page_screen.style.display = 'none';
}

function addEvent( obj, type, fn ) {
	if ( obj.attachEvent ) {
		obj['e'+type+fn] = fn;
		obj[type+fn] = function(){obj['e'+type+fn]( window.event );}
		obj.attachEvent( 'on'+type, obj[type+fn] );
	} else
		obj.addEventListener( type, fn, false );
}


function addLoadEvent(func) {
   var oldonload = window.onload;
   if (typeof window.onload != "function") {
	  window.onload = func;
   } else {
	  window.onload = function() {
		 if (oldonload) {
			oldonload();
		 }
		 func();
	  };
   }
}


var Reloader = {
	CONFIG_REFRESH_TIMER : 0,
	REFRESH_BLOCKED : false,
	STOP_REFRESH : false,
	UPDATE_STATUS : true,

	init : function(CONFIG_REFRESH_TIMER)
	{
		Reloader.CONFIG_REFRESH_TIMER = CONFIG_REFRESH_TIMER;
		setInterval("Reloader.checkRefresh()", CONFIG_REFRESH_TIMER*1000);
	},

	checkRefresh : function()
	{
		Reloader.UPDATE_STATUS = true;
		if (Reloader.STOP_REFRESH) {
			return;
		}
		if (hostReachable()) {
			top.location.reload();
		}
	},

	stopRefresh : function()
	{
		Reloader.UPDATE_STATUS = false;
		Reloader.STOP_REFRESH = true;
	},

	closeWindow : function()
	{
		Reloader.STOP_REFRESH = false;
		if (Reloader.UPDATE_STATUS) {
			if (hostReachable()) {
				top.location.reload();
			}
		}
	}
};

// cr?ation, lecture et suppression de cookie
function getCookie( name ) {
	var start = document.cookie.indexOf( name + "=" );
	var len = start + name.length + 1;
	if ( ( !start ) && ( name != document.cookie.substring( 0, name.length ) ) ) {
		return null;
	}
	if ( start == -1 ) return null;
	var end = document.cookie.indexOf( ";", len );
	if ( end == -1 ) end = document.cookie.length;
	return unescape( document.cookie.substring( len, end ) );
}

// expires : ? indiquer en jours
function setCookie( name, value, expires, path, domain, secure ) {
	var today = new Date();
	today.setTime( today.getTime() );
	if ( expires ) {
		expires = expires * 1000 * 60 * 60 * 24;
	}
	var expires_date = new Date( today.getTime() + (expires) );
	document.cookie = name+"="+escape( value ) +
		( ( expires ) ? ";expires="+expires_date.toGMTString() : "" ) + //expires.toGMTString()
		( ( path ) ? ";path=" + path : "" ) +
		( ( domain ) ? ";domain=" + domain : "" ) +
		( ( secure ) ? ";secure" : "" );
}

function deleteCookie( name, path, domain ) {
	if ( getCookie( name ) ) document.cookie = name + "=" +
			( ( path ) ? ";path=" + path : "") +
			( ( domain ) ? ";domain=" + domain : "" ) +
			";expires=Thu, 01-Jan-1970 00:00:01 GMT";
}


// fonctions pour textarea auto-enlarge
function attachAutoResizeEvents(obj)
{
	var txtX=document.getElementById(obj)
	var minH=txtX.style.height.substr(0,txtX.style.height.indexOf('px'))
	txtX.onchange=new Function("resize(this,"+minH+")")
	txtX.onkeyup=new Function("resize(this,"+minH+")")
	txtX.onchange(txtX,minH)
}
function resize(txtX,minH)
{   txtX.style.height = 'auto' // required when delete, cut or paste is performed
    txtX.style.height = txtX.scrollHeight+'px'
    if(txtX.scrollHeight<=minH)
        txtX.style.height = minH+'px'
}


function getRadioValue(idOrName) {
	var value = null;
	var element = document.getElementById(idOrName);
	var radioGroupName = null;

	// if null, then the id must be the radio group name
	if (element == null) {
		radioGroupName = idOrName;
	} else {
		radioGroupName = element.name;
	}
	if (radioGroupName == null) {
		return null;
	}
	var radios = document.getElementsByTagName('input');
	for (var i=0; i<radios.length; i++) {
		var input = radios[ i ];
		if (input.type == 'radio' && input.name == radioGroupName && input.checked) {
			value = input.value;
			break;
		}
	}
	return value;
}

function fermerMessage() {
	document.getElementById('divMessage').style.display = "none";
}

function videChampsFinTache(actif) {
	var champs = new Array();
	champs['date_fin'] = 'text';
	/*champs['nb_jours'] = 'text';*/
	champs['duree'] = 'text';
	champs['heure_debut'] = 'text';
	champs['heure_fin'] = 'text';
	champs['matin'] = 'checkbox';
	champs['apresmidi'] = 'checkbox';
	for (var valeur in champs) {
		if (valeur == actif) {
			continue;
		}
		if (valeur == 'heure_fin' && actif == 'heure_debut') {
			continue;
		}
		if (valeur == 'heure_debut' && actif == 'heure_fin') {
			continue;
		}
		if (champs[valeur] == 'text') {
			document.getElementById(valeur).value = '';
		}
		if (champs[valeur] == 'checkbox') {
			document.getElementById(valeur).checked = false;
		}
	}
}

function hours_am_pm(ts) {
  var H = +ts.substr(0, 2);
  var h = (H % 12) || 12;
  h = (h < 10)?("0"+h):h;  // leading 0 at the left for 1 digit hours
  var ampm = H < 12 ? "AM" : "PM";
  ts = h + ':' + ts.substr(3, 2) + ampm;
  return ts;
    }

/* */
function heurefinSynchro(heure,step)
{
	heure2=hours_am_pm(heure);
	$('#heure_fin').timepicker('option',
		{
			'show2400': 'true',
			'timeFormat': 'H\\:i',
			'step':step,
			'scrollDefault': heure2,
			'minTime': heure2,
			'durationTime': heure2,
			'showDuration':true
		});
	
}
/* Function for init select2 dropdown */
function initselect2(lang,choix,parentModal) {
	// init select2 if element is optionnal
	jQuery(".select2").select2({
			allowClear: true, 
			language: lang, 
			tags: "true",
			theme: 'bootstrap',
			width: 'resolve',
			placeholder: choix
			});
	$('.select2-search__field').css('width', '105%');
	if ($.fn.modal){
		$.fn.modal.Constructor.prototype._enforceFocus = function() {};
	}
}


function chargerYScrollPos(){
	window.scrollTo(0,yscroll);
}

function hostReachable() {
	// Handle IE and more capable browsers
	var xhr = new ( window.ActiveXObject || XMLHttpRequest )( "Microsoft.XMLHTTP" );
	var status;

	// Open new request as a HEAD to the root hostname with a random param to bust the cache
	xhr.open( "HEAD", window.location.href + "/?rand=" + Math.floor((1 + Math.random()) * 0x10000), false );

	// Issue request and handle response
	try {
		xhr.send();
		if (xhr.status >= 200 && xhr.status < 304) {
			return true;
		} else {
			return false;
		}
	} catch (e) {
		return false;
	}
}

// get checkboxes value for the given prefix
function getCheckboxes(formName, inputPrefix) {
	var resultat = new Array();
	var inputList = document.forms[formName].elements;
	var compteur = 0;
	for(compteur;compteur!=inputList.length;compteur++){
		var str = inputList[compteur].id;
		var tab = str.split("_");
		if (tab[0] == inputPrefix && inputList[compteur].checked) {
			resultat.push(inputList[compteur].value);
		}
	}
	return resultat;
}
// get Select value, return select value or array of values if multiple select
function getSelectValue(selectId)
{
	var elmt = document.getElementById(selectId);
	if(elmt.multiple == false)
	{
		return elmt.options[elmt.selectedIndex].value;
	}
	var values = new Array();
	for(var i=0; i< elmt.options.length; i++)
	{
		if(elmt.options[i].selected == true)
		{
			values[values.length] = elmt.options[i].value;
		}
	}
	return values;
}

function loadScript(url, callback){

    var script = document.createElement("script")
    script.type = "text/javascript";
    if (script.readyState){  //IE
        script.onreadystatechange = function(){
            if (script.readyState == "loaded" ||
                    script.readyState == "complete"){
                script.onreadystatechange = null;
                callback();
            }
        };
    } else {  //Others
        script.onload = function(){
            callback();
        };
    }
    script.src = url;
    document.getElementsByTagName("head")[0].appendChild(script);
}

function loadjscssfile(filename, filetype){
    if (filetype=="js"){ //if filename is a external JavaScript file
        var fileref=document.createElement('script')
        fileref.setAttribute("type","text/javascript")
        fileref.setAttribute("src", filename)
    }
    else if (filetype=="css"){ //if filename is an external CSS file
        var fileref=document.createElement("link")
        fileref.setAttribute("rel", "stylesheet")
        fileref.setAttribute("type", "text/css")
        fileref.setAttribute("href", filename)
    }
    if (typeof fileref!="undefined")
        document.getElementsByTagName("head")[0].appendChild(fileref)
}

function cellClic(id,type) {
	Reloader.stopRefresh();
	// Nouvelle tache
	if (type==1) {
		var idtab=id.split('_');
		var projet=idtab[1];
		var annee=idtab[2].substring(0, 4);
		var mois=idtab[2].substring(4, 6);
		var jour=idtab[2].substring(6, 8);
		var datedebut=annee+'-'+mois+'-'+jour;
		if (idtab[3] == null)
		{
			xajax_ajoutPeriode(datedebut, projet);
		} else {
			xajax_ajoutPeriode(datedebut, projet,'',idtab[3]);
		}
	}else {
		var idtab=id.split('_');
		xajax_modifPeriode(idtab[1]);
	}
	return false;
}

// Gestion du drag & drop
function allowDrop(ev) {
	ev.preventDefault();
    var el = ev.target;
    var parent = el.getAttribute("data-parent");
    if (parent != null)
    {
        var el = document.getElementById(parent);
        $('#'+parent).attr("drop-active", true);
    }else
    {
        $(ev.target).attr("drop-active", true);
    }
}

function leaveDropZone(ev) {
	ev.preventDefault();
    var el = ev.target;
    var parent = el.getAttribute("data-parent");
    if (parent != null)
    {
        var el = document.getElementById(parent);
        $('#'+parent).removeAttr("drop-active", true);
    }else
    {
       $(ev.target).removeAttr("drop-active", true);
    }
}

function drag(ev) {
	idDrag=ev.target.id;
	$('#'+idDrag).tooltip('hide');
	$('#'+idDrag).tooltip('disable');
	var el = ev.target;
	var parent = el.getAttribute("data-parent");
	if(!parent){
		el.setAttribute("data-parent", el.parentNode.id);
	}
	dragElementParent = el.parentNode.id;
	var oldDragBorder=ev.target.style.border;
	ev.target.style.border = "1px solid red";
	ev.dataTransfer.setData("Text", el.id);
}

function drop(ev) {
	ev.preventDefault();
	var data = ev.dataTransfer.getData("Text");
	var dragElement = ev;
    if (ev.target.id != data)
    {
	    ev.target.appendChild(document.getElementById(data));
        $(ev.target).removeAttr("drop-active");
	    idCaseEnCoursDeplacement = data;
	    //idCaseDestination = ev.target.id;
		var el = ev.target;
		var dataparent = el.getAttribute("data-parent");
		if (dataparent != null)
		{
			idCaseDestination = dataparent;
		}else idCaseDestination = ev.target.id;
	    var el=document.getElementById('divChoixDragNDrop');
	    var offset=$('#'+idCaseDestination).offset();
	    el.style.position = 'absolute';
	    el.style.top = offset.top + 20 + "px";
	    el.style.left = offset.left + 20 + "px";
	    el.style.display = 'block';
    }
}

function multiselecthide() {
   // hide other menus before showing this one
   $('.ms-options-wrap > .ms-options.ms-active').each(function(){
      $(this).removeClass('ms-active');
    });
}

function desactiverRappelVersion () {
	setCookie('infosVersionInactif', '1', 30, '/');
}

function convertToAscii(string) {
    const unicodeToAsciiMap = {'Èº':'A','Ã':'AE','êº':'AV','Æ':'B','É':'B','Æ':'B','Æ':'C','È»':'C','Æ':'D','Ç²':'D','Ç':'D','Ä':'D','Æ':'D','Ç':'DZ','É':'E','êª':'ET','Æ':'F','Æ':'G','Ç¤':'G','â±§':'H','Ä¦':'H','Æ':'I','ê¹':'D','ê»':'F','ê½':'G','ê':'R','ê':'S','ê':'T','ê¬':'IS','É':'J','â±©':'K','ê':'K','Æ':'K','ê':'K','ê':'K','È½':'L','â± ':'L','ê':'L','Ä¿':'L','â±¢':'L','Ç':'L','Å':'L','â±®':'M','Æ':'N','È ':'N','Ç':'N','ê':'O','ê':'O','Æ':'O','Ã':'O','Æ¢':'OI','Æ':'E','Æ':'O','È¢':'OU','ê':'P','Æ¤':'P','ê':'P','â±£':'P','ê':'P','ê':'Q','ê':'Q','É':'R','â±¤':'R','ê¾':'C','Æ':'E','È¾':'T','Æ¬':'T','Æ®':'T','Å¦':'T','â±¯':'A','ê':'L','Æ':'M','É':'V','ê':'V','Æ²':'V','â±²':'W','Æ³':'Y','á»¾':'Y','É':'Y','â±«':'Z','È¤':'Z','Æµ':'Z','Å':'OE','á´':'A','á´':'AE','Ê':'B','á´':'B','á´':'C','á´':'D','á´':'E','ê°':'F','É¢':'G','Ê':'G','Ê':'H','Éª':'I','Ê':'R','á´':'J','á´':'K','Ê':'L','á´':'L','á´':'M','É´':'N','á´':'O','É¶':'OE','á´':'O','á´':'OU','á´':'P','Ê':'R','á´':'N','á´':'R','ê±':'S','á´':'T','â±»':'E','á´':'R','á´':'U','á´ ':'V','á´¡':'W','Ê':'Y','á´¢':'Z','á¶':'a','áº':'a','â±¥':'a','Ã¦':'ae','ê»':'av','É':'b','áµ¬':'b','á¶':'b','Æ':'b','Æ':'b','Éµ':'o','É':'c','Æ':'c','È¼':'c','È¡':'d','É':'d','á¶':'d','áµ­':'d','á¶':'d','Ä':'d','É':'d','Æ':'d','Ä±':'i','È·':'j','É':'j','Ê':'j','Ç':'dz','â±¸':'e','á¶':'e','É':'e','ê«':'et','Æ':'f','áµ®':'f','á¶':'f','É ':'g','á¶':'g','Ç¥':'g','â±¨':'h','É¦':'h','Ä§':'h','Æ':'hv','á¶':'i','É¨':'i','êº':'d','ê¼':'f','áµ¹':'g','ê':'r','ê':'s','ê':'t','ê­':'is','Ê':'j','É':'j','â±ª':'k','ê':'k','Æ':'k','á¶':'k','ê':'k','ê':'k','Æ':'l','É¬':'l','È´':'l','â±¡':'l','ê':'l','Å':'l','É«':'l','á¶':'l','É­':'l','Å':'l','Å¿':'s','áº':'s','áº':'s','É±':'m','áµ¯':'m','á¶':'m','Èµ':'n','É²':'n','Æ':'n','áµ°':'n','á¶':'n','É³':'n','ê':'o','ê':'o','â±º':'o','Ã¸':'o','Æ£':'oi','É':'e','á¶':'e','É':'o','á¶':'o','È£':'ou','ê':'p','Æ¥':'p','áµ±':'p','á¶':'p','ê':'p','áµ½':'p','ê':'p','ê':'q','Ê ':'q','É':'q','ê':'q','É¾':'r','áµ³':'r','É¼':'r','áµ²':'r','á¶':'r','É':'r','É½':'r','â':'c','ê¿':'c','É':'e','É¿':'r','Ê':'s','áµ´':'s','á¶':'s','È¿':'s','É¡':'g','á´':'o','á´':'o','á´':'u','È¶':'t','â±¦':'t','Æ­':'t','áµµ':'t','Æ«':'t','Ê':'t','Å§':'t','áµº':'th','É':'a','á´':'ae','Ç':'e','áµ·':'g','É¥':'h','Ê®':'h','Ê¯':'h','á´':'i','Ê':'k','ê':'l','É¯':'m','É°':'m','á´':'oe','É¹':'r','É»':'r','Éº':'r','â±¹':'r','Ê':'t','Ê':'v','Ê':'w','Ê':'y','á¶':'u','áµ«':'ue','ê¸':'um','â±´':'v','ê':'v','Ê':'v','á¶':'v','â±±':'v','â±³':'w','á¶':'x','Æ´':'y','á»¿':'y','É':'y','Ê':'z','â±¬':'z','È¥':'z','áµ¶':'z','á¶':'z','Ê':'z','Æ¶':'z','É':'z','Å':'oe','â':'x'};
    const stringWithoutAccents = string.normalize("NFD").replace(/[\u0300-\u036f]/g, '');
    return stringWithoutAccents.replace(/[^\u0000-\u007E]/g, character => unicodeToAsciiMap[character] || '');
}

function fileUpload() {
	$('#divPatienter2').removeClass('d-none');
	$('#file-select-button').off('click');
	$('#butSubmitPeriode').prop('disabled', true);
	var formData = new FormData();
	var fileData = $('#fichier').prop('files');
	var linkid = $('#link_id').val();
	var periodeid = $('#periode_id').val();
    var filename=$('#fichier')[0].files[0]['name'];
	filename = convertToAscii(filename);
	var filenamesize=$('#fichier')[0].files[0]['size'];
	var max_size_upload=$('#max_size_upload').val();
	if(filename && filenamesize < max_size_upload)
	{
		$('<div><a href="upload/files/'+linkid+'/'+filename+'" class="ellipsis fileupload" target="_blank" id="fichier_periode" style="float:left;">'+filename+'</a>&nbsp;<i class="fa fa-trash fa-fw" aria-hidden="true" onclick="fileRemove(\''+filename+'\',this.closest(\'div\'));" id="fileremovebutton" style="margin-top:4px;margin-left:4px;float:left;cursor:pointer;"></i></div>').insertBefore( $('#lastfile') );
		var json_files="";
		jQuery.each(jQuery('.fileupload'), function(i, file) {
			if (json_files != '') { json_files = json_files + ';'; }
			json_files = json_files + file.innerHTML;
		});
		$("#liste_fichiers").val(json_files);

		if (fileData)
		{	
			jQuery.each(jQuery('#fichier').prop('files'), function(i, file) {
				formData.append('fichier-'+i, file);
			});
			formData.append('linkid', linkid);
			formData.append('periodeid', periodeid);
			formData.append('fichiers', json_files);
			formData.append('type', 'upload');
			$.ajax({
				url			: 'process/upload.php',
				cache       : false,
				contentType : false,
				processData : false,
				data        : formData,                         
				type        : 'post',     
				success		: function(message){
								if (message)
								{
									alert(message);
									return false;
								}
					}
			});
		}
		$('#fichier').val('');
	}else
	{
		alert($('#max_size_upload_error').val());
	}
	$('#file-select-button').on('click',file_upload_click);
	$('#divPatienter2').addClass('d-none');
	$('#butSubmitPeriode').prop('disabled', false);
	return true;
	};
	
	function fileRemove(fichier,div) {
		var suppression_upload=$("#suppression_upload").val();
		var json_files="";
		var formData = new FormData();
		var linkid = $('#link_id').val();
		var periodeid = $('#periode_id').val();
		
		if(confirm(suppression_upload))
		{
			div.remove();
			liste_fichiers=$("#liste_fichiers").val();
			ret = liste_fichiers.replace('{"filename":"'+fichier+'"}','');
			jQuery.each(jQuery('.fileupload'), function(i, file) {
				if (json_files != '') { json_files = json_files + ';'; }
				json_files = json_files + file.innerHTML;
			});
			$("#liste_fichiers").val(json_files);

			formData.append('linkid', linkid);
			formData.append('periodeid', periodeid);
			formData.append('type', 'delete');
			formData.append('fichier_to_delete',fichier);
			formData.append('fichiers', json_files);
			$.ajax({
				url			: 'process/upload.php',
				cache       : false,
				contentType : false,
				processData : false,
				data        : formData,                         
				type        : 'post',     
				success		: function(message){
					if (message)
						{
							alert(message);
							return false;
						}
				}
			});
		}
	}
